<!-- Membership Pricing Section -->
<style>
    .membership-card {
        background-color: #E7EBFF;
        padding: 20px;
        display: flex;
        justify-content: center;
        border-radius: 20px;
        transition: background-color 0.3s ease;
    }
    .membership-card:hover {
        background-color: #D1D9FF;
    }
    .signup-button {
        background-color: #8C9EFF;
        transition: background-color 0.3s ease;
    }
    .signup-button:hover {
        background-color: #7A8EFF;
    }
</style>
<div class="w-full mx-auto md:w-10/12 lg:w-9/12 lg:text-lg" id="membership-pricing">
    <!-- Header -->
    <div class="text-center mb-8 md:mb-12">
        <p class="text-medium lg:text-lg mb-3 text-blue font-semibold">Become a member</p>
        <h2 class="text-8xl lg:text-10xl mb-4 font-bold capitalize text-center tracking-tighter">Book, repair, drive.</h2>
    </div>

    <!-- Membership Cards will be generated dynamically from config -->
    <div id="membership-cards-container"></div>
</div>

<!-- Signup Modal -->
<div class="fixed z-[999] h-screen w-full left-0 top-0 opacity-0 pointer-events-none overflow-auto bg-black/80 hidden transition-opacity duration-300 group/modal group-[.ready]/body:block [&.is-open]:opacity-100 [&.is-open]:pointer-events-auto" id="signupModal" role="dialog" aria-labelledby="signupModal" aria-hidden="true">
    <div tabindex="-1" data-mm-dismiss class="w-full h-full">
        <div role="dialog" aria-modal="true" aria-labelledby="signupModal-title" class="h-full px-4 py-8 lg:py-10 flex justify-center items-center">
            <div id="signupModal-content" class="m-auto w-full text-center max-w-xl bg-white translate-y-8 transition-transform duration-300 px-5 pt-10 pb-6 md:px-10 md:py-10 motion-reduce:transition-none group-[.is-open]/modal:translate-y-0 rounded-lg" onclick="event.stopPropagation();" onsubmit="return false;">
                <span data-mm-dismiss class="block text-black absolute top-4 right-4 md:top-5 md:right-5 cursor-pointer w-4">
                    <svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-auto pointer-events-none">
                        <path d="M16.7071 1.70711C17.0976 1.31658 17.0976 0.683417 16.7071 0.292893C16.3166 -0.0976311 15.6834 -0.0976311 15.2929 0.292893L16.7071 1.70711ZM0.292893 15.2929C-0.0976311 15.6834 -0.0976311 16.3166 0.292893 16.7071C0.683417 17.0976 1.31658 17.0976 1.70711 16.7071L0.292893 15.2929ZM1.70711 0.292893C1.31658 -0.0976311 0.683417 -0.0976311 0.292893 0.292893C-0.0976311 0.683417 -0.0976311 1.31658 0.292893 1.70711L1.70711 0.292893ZM15.2929 16.7071C15.6834 17.0976 16.3166 17.0976 16.7071 16.7071C17.0976 16.3166 17.0976 15.6834 16.7071 15.2929L15.2929 16.7071ZM15.2929 0.292893L0.292893 15.2929L1.70711 16.7071L16.7071 1.70711L15.2929 0.292893ZM0.292893 1.70711L15.2929 16.7071L16.7071 15.2929L1.70711 0.292893L0.292893 1.70711Z" fill="black" />
                    </svg>
                </span>
                <div class="lg:text-xl">
                    <h3 id="signupModal-title" class="text-2xl lg:text-3xl font-bold leading-tight mb-5">
                        Sign Up
                    </h3>
                    <p id="selectedProductInfo" class="text-sm text-gray-600 mb-4 hidden"></p>
                    <form id="signupForm" class="text-left" action="#" method="post">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="signup-email">Email <span class="text-red-500">*</span></label>
                            <input type="email" id="signup-email" name="email" class="text-base appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue" placeholder="Enter your email" required>
                            <span class="error-message text-red-500 text-sm hidden"></span>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="signup-phone">Mobile Number <span class="text-red-500">*</span></label>
                            <input type="tel" id="signup-phone" name="phone" class="text-base appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue" placeholder="" required>
                            <span class="error-message text-red-500 text-sm hidden"></span>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="signup-firstname">First Name <span class="text-red-500">*</span></label>
                            <input type="text" id="signup-firstname" name="firstName" class="text-base appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue" placeholder="Enter your first name" required>
                            <span class="error-message text-red-500 text-sm hidden"></span>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2" for="signup-lastname">Last Name <span class="text-red-500">*</span></label>
                            <input type="text" id="signup-lastname" name="lastName" class="text-base appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-blue" placeholder="Enter your last name" required>
                            <span class="error-message text-red-500 text-sm hidden"></span>
                        </div>
                        <div class="mb-6">
                            <label class="flex items-start">
                                <input type="checkbox" id="signup-terms" name="terms" class="mt-1 mr-2" required>
                                <span class="text-sm text-gray-700">I agree to Assure Scratch and Dent <a href="/terms-and-conditions.pdf" target="_blank" class="text-blue underline">terms and conditions</a> <span class="text-red-500">*</span></span>
                            </label>
                            <span class="error-message text-red-500 text-sm hidden"></span>
                        </div>

                        <button type="button" id="signupSubmit" class="signup-button w-full text-center px-4 py-3 rounded-lg font-semibold text-white transition duration-300">
                            Continue
                        </button>
                        <div id="signupFormMessages" class="form-messages mt-5 text-sm [&.error]:text-red-500 [&.success]:text-green-600 hidden"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Membership Config - Inline configuration -->
<script>
    // Configuration values - update here when prices change
    // This ensures it's always available regardless of Vite bundling
    window.MembershipConfig = {
        // Product groups - each group contains annual and monthly products
        PRODUCT_GROUPS: [
            {
                name: 'Platinum',
                title: 'Assure Platinum $0 repair fee*',
                description: 'All the good things included with gold minus the $50 call out fee*',
                showDescription: true,
                products: [
                    {
                        id: 32,
                        name: 'Assure Platinum Annual',
                        type: 'annual',
                        price: 529,  // Discounted price (10% off from 528)
                        monthlyPrice: 44,  // Price per month (529 / 12)
                        originalPrice: 528  // Original price before discount
                    },
                    {
                        id: 33,
                        name: 'Assure Platinum Monthly',
                        type: 'monthly',
                        price: 49,  // Monthly price
                        monthlyPrice: 49,
                        totalAnnual: 588  // 12 months total (49 * 12)
                    }
                ]
            },
            {
                name: 'Gold',
                title: 'Assure Gold $50 repair fee*',
                description: '',
                showDescription: false,
                products: [
                    {
                        id: 34,
                        name: 'Assure Gold Annual',
                        type: 'annual',
                        price: 378,  // Discounted price (10% off from 408)
                        monthlyPrice: 31.5,  // Price per month (367 / 12)
                        originalPrice: 420  // Original price before discount
                    },
                    {
                        id: 35,
                        name: 'Assure Gold Monthly',
                        type: 'monthly',
                        price: 35,  // Monthly price
                        monthlyPrice: 35,
                        totalAnnual: 420  // 12 months total (35 * 12)
                    }
                ]
            }
        ],
        DEALER_ID: 7,
        CAMPAIGN_NAME: 'joinassureusa',
        // Helper function to get RRP by product ID (for backward compatibility)
        getRRP: function(productId) {
            for (const group of this.PRODUCT_GROUPS) {
                const product = group.products.find(p => p.id === productId);
                if (product) {
                    return product.price;
                }
            }
            return null;
        },
        // Helper function to get product by ID
        getProduct: function(productId) {
            for (const group of this.PRODUCT_GROUPS) {
                const product = group.products.find(p => p.id === productId);
                if (product) {
                    return { ...product, groupName: group.name };
                }
            }
            return null;
        }
    };
    
    console.log('âœ… Membership config loaded from inline script');
    console.log('DEALER_ID:', window.MembershipConfig.DEALER_ID);
    console.log('CAMPAIGN_NAME:', window.MembershipConfig.CAMPAIGN_NAME);
    console.log('PRODUCT_GROUPS:', window.MembershipConfig.PRODUCT_GROUPS);
</script>

<script type="module">
    // IMMEDIATE LOG - Script is loading
    console.log('ðŸš€ MEMBERSHIP PRICING SCRIPT LOADING...');
    console.log('Script location:', window.location.href);
    console.log('Current pathname:', window.location.pathname);
    
    // Get config from global window object (set by inline script above)
    if (!window.MembershipConfig) {
        const errorMsg = 'CRITICAL: MembershipConfig not found on window object. Config script may not have loaded.';
        console.error(errorMsg);
        alert(errorMsg);
        throw new Error(errorMsg);
    }
    
    const config = window.MembershipConfig;
    const getRRP = (productId) => config.getRRP(productId);
    const DEALER_ID = config.DEALER_ID;
    const CAMPAIGN_NAME = config.CAMPAIGN_NAME;
    
    console.log('âœ… Config loaded from window.MembershipConfig');
    console.log('DEALER_ID:', DEALER_ID);
    console.log('CAMPAIGN_NAME:', CAMPAIGN_NAME);
    console.log('PRODUCT_GROUPS:', config.PRODUCT_GROUPS);
    
    // Generate membership cards dynamically from config
    function generateMembershipCards() {
        const container = document.getElementById('membership-cards-container');
        if (!container) {
            console.error('Membership cards container not found');
            return;
        }
        
        container.innerHTML = ''; // Clear existing content
        
        config.PRODUCT_GROUPS.forEach(group => {
            // Find annual and monthly products
            const annualProduct = group.products.find(p => p.type === 'annual');
            const monthlyProduct = group.products.find(p => p.type === 'monthly');
            
            if (!annualProduct || !monthlyProduct) {
                console.warn(`Missing products for group: ${group.name}`);
                return;
            }
            
            // Create membership card section
            const cardSection = document.createElement('div');
            cardSection.className = 'membership-card mb-8 md:mb-12';
            
            cardSection.innerHTML = `
                <div class="flex flex-col lg:flex-row gap-6 lg:gap-8" style="align-items: center;">
                    <!-- Left Side - Title and Description -->
                    <div class="lg:w-1/2">
                        <h3 class="text-5xl lg:text-8xl font-bold text-blue mb-4">${group.title}</h3>
                        ${group.showDescription && group.description ? `
                            <p class="flex items-start text-base lg:text-lg text-black mb-0">
                                <icon src="check-blue.svg" class="w-5 h-5 mr-2 mt-1 flex-shrink-0"></icon>
                                ${group.description}
                            </p>
                        ` : ''}
                    </div>
                    
                    <!-- Right Side - Pricing Cards -->
                    <div class="lg:w-1/2 flex flex-col gap-4">
                        <!-- Annual Membership Card -->
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <p class="text-base lg:text-lg mb-3 font-semibold">Annual Membership</p>
                            <div class="flex items-baseline gap-2 mb-2">
                                <span class="text-5xl lg:text-6xl font-bold text-blue">$${annualProduct.price}</span>
                                <span class="text-lg text-gray-400 line-through">$${annualProduct.originalPrice}</span>
                            </div>
                            <p class="text-sm lg:text-base text-green-600 font-semibold mb-2">SAVE 10%</p>
                            <p class="text-sm lg:text-base text-gray-600 mb-4">Equal to $${annualProduct.monthlyPrice.toFixed(2)} p/m</p>
                            <a data-productId="${annualProduct.id}" data-mm-target="signupModal" class="signup-button inline-block w-full text-center px-4 py-3 rounded-lg font-semibold text-white cursor-pointer">
                                Sign-up
                            </a>
                        </div>
                        
                        <!-- Pay Monthly Card -->
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <p class="text-base lg:text-lg mb-3 font-semibold">Pay Monthly â€“ $${monthlyProduct.price} p/m</p>
                            <p class="text-sm lg:text-base text-gray-600 mb-4">12 Month minimum â€“ $${monthlyProduct.totalAnnual} total.</p>
                            <a data-productId="${monthlyProduct.id}" data-mm-target="signupModal" class="signup-button inline-block w-full text-center px-4 py-3 rounded-lg font-semibold text-white cursor-pointer">
                                Sign-up
                            </a>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(cardSection);
        });
        
        console.log('âœ… Membership cards generated from config');
    }
    
    // Generate cards when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', generateMembershipCards);
    } else {
        generateMembershipCards();
    }
    
    // ============================================
    // DEBUG FLAG - Set to false to disable all debugging logs
    // ============================================
    const DEBUG = true; // Change to true to enable debugging
    
    // Debug logging helper function
    const debugLog = (...args) => {
        if (DEBUG) {
            console.log(...args);
        }
    };
    
    const debugWarn = (...args) => {
        if (DEBUG) {
            console.warn(...args);
        }
    };
    
    const debugError = (...args) => {
        if (DEBUG) {
            console.error(...args);
        }
    };
    
    // Import MicroModal from CDN (works in browser without bundler)
    let MicroModal;
    let microModalLoaded = false;
    try {
        const micromodalModule = await import('https://cdn.jsdelivr.net/npm/micromodal@0.4.10/dist/micromodal.es.js');
        MicroModal = micromodalModule.default || micromodalModule;
        microModalLoaded = true;
        // console.log('MicroModal loaded successfully');
    } catch (error) {
        // console.error('Failed to load MicroModal:', error);
        console.error('Failed to load MicroModal:', error);
        alert('Error loading modal library. Please refresh the page.');
        // Create a fallback object to prevent errors
        MicroModal = {
            show: () => { console.error('MicroModal not loaded'); },
            init: () => { console.error('MicroModal not loaded'); }
        };
    }
    
    // Log that imports are loaded
    debugLog('Imports loaded:', { DEALER_ID, CAMPAIGN_NAME, getRRP: typeof getRRP, MicroModal: typeof MicroModal });

    // Get Facebook Pixel data from cookies
    function getFacebookPixel() {
        try {
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }
            
            // Get Facebook Browser ID (_fbp) - used for browser-based tracking
            const fbp = getCookie('_fbp');
            // Get Facebook Click ID (_fbc) - used for click-based tracking from ads
            const fbc = getCookie('_fbc');
            
            debugLog('Facebook cookies:', { fbp, fbc });
            
            // Prefer _fbc if available (more specific for ad clicks), otherwise use _fbp
            const pixelValue = fbc || fbp;
            if (!pixelValue) {
                // console.warn('No Facebook pixel cookie found, using default');
            }
            return pixelValue ? encodeURIComponent(pixelValue) : 'xxxxx';
        } catch (error) {
            // console.error('Error getting Facebook pixel:', error);
            return 'xxxxx';
        }
    }

    // Store selected product ID
    let selectedProductId = null;

    // Detect country based on domain
    function getCountryFromDomain() {
        const hostname = window.location.hostname.toLowerCase();
        if (hostname.includes('.com.au')) return 'AU';
        if (hostname.includes('.sg')) return 'SG';
        if (hostname.includes('.co.nz')) return 'NZ';
        if (hostname.includes('.in')) return 'IN';
        if (hostname.includes('.com')) return 'USA';
        // Default to AU if not detected
        return 'AU';
    }

    // Get country-specific phone placeholder
    function getPhonePlaceholder() {
        const country = getCountryFromDomain();
        switch (country) {
            case 'AU':
                return '04XX XXX XXX';
            case 'USA':
                return '(XXX) XXX-XXXX';
            case 'SG':
                return '8XXXXXXX';
            case 'NZ':
                return '02X XXX XXXX';
            case 'IN':
                return '9XXXXXXXXX';
            default:
                return 'Enter your mobile number';
        }
    }

    // Wait for DOM to be ready
    function initSignupModal() {
        // Set phone placeholder based on country
        const phoneInput = document.getElementById('signup-phone');
        if (phoneInput) {
            phoneInput.placeholder = getPhonePlaceholder();
        }
        
        // Handle signup button clicks
        document.querySelectorAll('[data-mm-target="signupModal"]').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                selectedProductId = button.getAttribute('data-productId');
                
                // Debug: Log selected product ID
                // console.log('Selected Product ID:', selectedProductId);
                
                // Show product info in modal
                const productInfo = document.getElementById('selectedProductInfo');
                if (productInfo) {
                    const productNames = {
                        '32': 'Assure Platinum - Annual Membership',
                        '33': 'Assure Platinum - Pay Monthly',
                        '34': 'Assure Gold - Annual Membership',
                        '35': 'Assure Gold - Pay Monthly'
                    };
                    productInfo.textContent = `Signing up for: ${productNames[selectedProductId] || 'Product ' + selectedProductId}`;
                    productInfo.classList.remove('hidden');
                }
                
                // Reset form when opening modal
                const form = document.getElementById('signupForm');
                if (form) {
                    form.reset();
                    form.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));
                    form.querySelectorAll('input').forEach(input => input.classList.remove('border-red-500'));
                    const messageDiv = document.getElementById('signupFormMessages');
                    if (messageDiv) messageDiv.classList.add('hidden');
                    
                    // Update phone placeholder
                    const phoneField = document.getElementById('signup-phone');
                    if (phoneField) {
                        phoneField.placeholder = getPhonePlaceholder();
                    }
                }
                
                // Reset submit button state
                const submitBtn = document.getElementById('signupSubmit');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Continue';
                }
                
                // Open modal using MicroModal (ensure it's loaded)
                if (!microModalLoaded || !MicroModal || typeof MicroModal.show !== 'function') {
                    console.error('MicroModal not available');
                    alert('Modal library is not loaded. Please refresh the page.');
                    return;
                }
                MicroModal.show('signupModal', {
                    openTrigger: 'data-mm-target',
                    closeTrigger: 'data-mm-dismiss',
                    openClass: 'is-open',
                    onShow: () => {
                        document.body.classList.add('overflow-hidden');
                        
                        // Reset submit button state when modal opens
                        const submitBtn = document.getElementById('signupSubmit');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Continue';
                        }
                        
                        // Ensure form handler is initialized when modal opens
                        setTimeout(() => {
                            debugLog('=== MODAL OPENED - CHECKING FORM ELEMENTS ===');
                            
                            // Test if form and button exist
                            const testForm = document.getElementById('signupForm');
                            const testBtn = document.getElementById('signupSubmit');
                            debugLog('After modal open - Form exists:', !!testForm);
                            debugLog('After modal open - Button exists:', !!testBtn);
                            debugLog('Form handler initialized flag:', formHandlerInitialized);
                            
                            if (testForm && testBtn) {
                                debugLog('âœ… Form elements found in modal, ensuring handler is initialized');
                            // Initialize form handler (will skip if already initialized)
                            initFormHandler();
                            } else {
                                debugError('âŒ Form elements NOT found in modal!');
                                debugError('Form:', testForm);
                                debugError('Button:', testBtn);
                            }
                            
                            // Ensure button is still reset after handler initialization
                            if (testBtn) {
                                testBtn.disabled = false;
                                testBtn.textContent = 'Continue';
                            }
                        }, 100);
                    },
                    onClose: () => {
                        document.body.classList.remove('overflow-hidden');
                    }
                });
            });
        });
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSignupModal);
    } else {
        initSignupModal();
    }

    // Validation functions
    function validateEmail(email) {
        const re = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;
        return re.test(email);
    }

    function validatePhone(phone) {
        if (!phone || phone.trim() === '') {
            return false;
        }
        
        const country = getCountryFromDomain();
        // Remove spaces, dashes, parentheses, and plus signs for validation (we'll handle country codes separately)
        let cleaned = phone.replace(/[\s\-\(\)]/g, '');
        
        // Check if it contains only digits and allowed characters
        if (!/^[\d+]+$/.test(cleaned)) {
            return false;
        }
        
        switch (country) {
            case 'AU': // Australia
                // Australian mobile: must start with 04 and be 10 digits total
                // Can have +61 or 0 prefix
                if (cleaned.startsWith('+61')) {
                    cleaned = cleaned.substring(3);
                } else if (cleaned.startsWith('61')) {
                    cleaned = cleaned.substring(2);
                } else if (cleaned.startsWith('0')) {
                    cleaned = cleaned.substring(1);
                }
                // Mobile numbers must start with 4 and be 9 digits (after removing country code)
                return /^4\d{8}$/.test(cleaned) && cleaned.length === 9;
                
            case 'USA': // United States
                // US phone: exactly 10 digits, can have +1 prefix
                if (cleaned.startsWith('+1')) {
                    cleaned = cleaned.substring(2);
                } else if (cleaned.startsWith('1') && cleaned.length === 11) {
                    cleaned = cleaned.substring(1);
                }
                // Must be exactly 10 digits, first digit cannot be 0 or 1
                return /^[2-9]\d{9}$/.test(cleaned) && cleaned.length === 10;
                
            case 'SG': // Singapore
                // Singapore mobile: 8 digits starting with 6, 8, or 9
                if (cleaned.startsWith('+65')) {
                    cleaned = cleaned.substring(3);
                } else if (cleaned.startsWith('65')) {
                    cleaned = cleaned.substring(2);
                }
                // Must be exactly 8 digits starting with 6, 8, or 9
                return /^[689]\d{7}$/.test(cleaned) && cleaned.length === 8;
                
            case 'NZ': // New Zealand
                // New Zealand mobile: 8-9 digits, mobile starts with 2
                if (cleaned.startsWith('+64')) {
                    cleaned = cleaned.substring(3);
                } else if (cleaned.startsWith('64')) {
                    cleaned = cleaned.substring(2);
                } else if (cleaned.startsWith('0')) {
                    cleaned = cleaned.substring(1);
                }
                // Mobile numbers start with 2 and are 8-9 digits
                return /^2\d{7,8}$/.test(cleaned) && (cleaned.length === 8 || cleaned.length === 9);
                
            case 'IN': // India
                // Indian mobile: 10 digits starting with 6, 7, 8, or 9
                if (cleaned.startsWith('+91')) {
                    cleaned = cleaned.substring(3);
                } else if (cleaned.startsWith('91')) {
                    cleaned = cleaned.substring(2);
                } else if (cleaned.startsWith('0')) {
                    cleaned = cleaned.substring(1);
                }
                // Must be exactly 10 digits starting with 6-9
                return /^[6-9]\d{9}$/.test(cleaned) && cleaned.length === 10;
                
            default:
                // Fallback: at least 8 digits
                const digitsOnly = cleaned.replace(/\D/g, '');
                return digitsOnly.length >= 8 && digitsOnly.length <= 15;
        }
    }

    function validateName(name) {
        return name.trim().length >= 2;
    }

    function showFieldError(field, message) {
        const errorSpan = field.parentElement.querySelector('.error-message');
        if (errorSpan) {
            errorSpan.textContent = message;
            errorSpan.classList.remove('hidden');
        }
        field.classList.add('border-red-500');
    }

    function clearFieldError(field) {
        const errorSpan = field.parentElement.querySelector('.error-message');
        if (errorSpan) {
            errorSpan.classList.add('hidden');
        }
        field.classList.remove('border-red-500');
    }

    function showFormMessage(message, type) {
        const messageDiv = document.getElementById('signupFormMessages');
        if (messageDiv) {
            messageDiv.textContent = message;
            messageDiv.className = `form-messages mt-5 text-sm ${type === 'error' ? 'text-red-500' : 'text-green-600'} hidden`;
            messageDiv.classList.remove('hidden');
        }
    }

    // Form submission handler - wait for form to exist
    let formHandlerInitialized = false;
    function initFormHandler() {
        // IMMEDIATE LOG - Always show initialization attempts
        console.log('ðŸ”§ INIT FORM HANDLER CALLED - Document ready:', document.readyState);
        
        debugLog('=== INIT FORM HANDLER CALLED ===');
        debugLog('Document ready state:', document.readyState);
        debugLog('Current time:', new Date().toISOString());
        
        const form = document.getElementById('signupForm');
        const submitBtn = document.getElementById('signupSubmit');
        
        // IMMEDIATE LOG - Always show if elements are found
        console.log('ðŸ” Looking for form elements:', {
            formFound: !!form,
            buttonFound: !!submitBtn,
            formId: form ? form.id : 'NOT FOUND',
            buttonId: submitBtn ? submitBtn.id : 'NOT FOUND'
        });
        
        debugLog('Form element found:', !!form, form);
        debugLog('Submit button found:', !!submitBtn, submitBtn);
        
        if (!form || !submitBtn) {
            // IMMEDIATE LOG - Always show retry attempts
            console.warn('âš ï¸ Form or button not found, retrying in 100ms...', { 
                form: !!form, 
                submitBtn: !!submitBtn,
                formId: form ? form.id : 'not found',
                buttonId: submitBtn ? submitBtn.id : 'not found'
            });
            debugWarn('âš ï¸ Form or button not found, retrying in 100ms...', { 
                form: !!form, 
                submitBtn: !!submitBtn,
                formId: form ? form.id : 'not found',
                buttonId: submitBtn ? submitBtn.id : 'not found'
            });
            setTimeout(initFormHandler, 100);
            return;
        }

        // IMMEDIATE LOG - Elements found
        console.log('âœ… Form and button found! Initializing handlers...');

        // Prevent duplicate initialization
        if (formHandlerInitialized) {
            debugLog('âš ï¸ Form handler already initialized, skipping...');
            return;
        }
        formHandlerInitialized = true;

        debugLog('âœ… Form handler initialized successfully');
        debugLog('Form element:', form);
        debugLog('Form ID:', form.id);
        debugLog('Submit button element:', submitBtn);
        debugLog('Submit button ID:', submitBtn.id);
        debugLog('Submit button type:', submitBtn.type);
        debugLog('Submit button disabled:', submitBtn.disabled);

        // Function to handle form submission
        async function handleFormSubmit(e) {
            // IMMEDIATE LOG - Always show when handler is called
            console.log('ðŸŽ¯ðŸŽ¯ðŸŽ¯ FORM SUBMIT HANDLER CALLED ðŸŽ¯ðŸŽ¯ðŸŽ¯');
            console.log('Event type:', e ? e.type : 'no event');
            console.log('Timestamp:', new Date().toISOString());
            
            debugLog('=== FORM SUBMIT HANDLER CALLED ===');
            debugLog('Event:', e);
            debugLog('Event type:', e ? e.type : 'no event');
            
            // Always prevent default and stop propagation
            if (e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.log('âœ… Event prevented and stopped');
                debugLog('Event prevented and stopped');
            }
            
            try {
                debugLog('=== STARTING FORM SUBMISSION ===');
                debugLog('Selected Product ID:', selectedProductId);
                debugLog('DEALER_ID:', DEALER_ID);
                debugLog('CAMPAIGN_NAME:', CAMPAIGN_NAME);
                debugLog('getRRP function available:', typeof getRRP);
                debugLog('MicroModal available:', typeof MicroModal);
                
                // Check if product ID is set
                if (!selectedProductId) {
                    const errorMsg = 'Error: No product selected. Please close and try again.';
                    debugError('âŒ No product ID selected!');
                    alert(errorMsg);
                    showFormMessage(errorMsg, 'error');
                    return false;
                }
                debugLog('âœ… Product ID check passed:', selectedProductId);
                
            debugLog('=== COLLECTING FORM VALUES ===');
            const emailEl = document.getElementById('signup-email');
            const phoneEl = document.getElementById('signup-phone');
            const firstNameEl = document.getElementById('signup-firstname');
            const lastNameEl = document.getElementById('signup-lastname');
            const termsEl = document.getElementById('signup-terms');
            
            debugLog('Form elements found:', {
                email: !!emailEl,
                phone: !!phoneEl,
                firstName: !!firstNameEl,
                lastName: !!lastNameEl,
                terms: !!termsEl
            });

            const email = emailEl ? emailEl.value.trim() : '';
            const phone = phoneEl ? phoneEl.value.trim() : '';
            const firstName = firstNameEl ? firstNameEl.value.trim() : '';
            const lastName = lastNameEl ? lastNameEl.value.trim() : '';
            const terms = termsEl ? termsEl.checked : false;

            debugLog('Form values collected:', { 
                email: email ? email.substring(0, 3) + '***' : 'empty',
                phone: phone ? phone.substring(0, 3) + '***' : 'empty',
                firstName: firstName || 'empty',
                lastName: lastName || 'empty',
                terms: terms
            });

                // Clear previous errors
                form.querySelectorAll('.error-message').forEach(el => el.classList.add('hidden'));
                form.querySelectorAll('input').forEach(input => input.classList.remove('border-red-500'));

            // First, check HTML5 native validation (required fields, email format, etc.)
            console.log('ðŸ” Checking HTML5 form validation...');
            debugLog('=== CHECKING HTML5 VALIDATION ===');
            
            if (!form.checkValidity()) {
                // HTML5 validation failed - show browser's native validation messages
                console.warn('âš ï¸ HTML5 validation failed, showing native validation messages');
                debugWarn('âš ï¸ HTML5 validation failed');
                form.reportValidity(); // This shows the browser's native validation messages
                return false;
            }
            
            console.log('âœ… HTML5 validation passed, proceeding with custom validation');
            debugLog('âœ… HTML5 validation passed');

                let isValid = true;
            debugLog('=== STARTING CUSTOM VALIDATION ===');

                // Validate email
            debugLog('Validating email...');
                if (!email) {
                debugLog('âŒ Email validation failed: empty');
                    showFieldError(document.getElementById('signup-email'), 'Email is required');
                    isValid = false;
                } else if (!validateEmail(email)) {
                debugLog('âŒ Email validation failed: invalid format');
                    showFieldError(document.getElementById('signup-email'), 'Please enter a valid email address');
                    isValid = false;
            } else {
                debugLog('âœ… Email validation passed');
                }

                // Validate phone
                const country = getCountryFromDomain();
                let phoneErrorMessage = 'Please enter a valid mobile number';
                
                // Country-specific error messages
                switch (country) {
                    case 'AU':
                        phoneErrorMessage = 'Please enter a valid Australian mobile number (e.g., 04XX XXX XXX)';
                        break;
                    case 'USA':
                        phoneErrorMessage = 'Please enter a valid US phone number (e.g., (XXX) XXX-XXXX)';
                        break;
                    case 'SG':
                        phoneErrorMessage = 'Please enter a valid Singapore mobile number (8 digits starting with 6, 8, or 9)';
                        break;
                    case 'NZ':
                        phoneErrorMessage = 'Please enter a valid New Zealand mobile number (8-9 digits)';
                        break;
                    case 'IN':
                        phoneErrorMessage = 'Please enter a valid Indian mobile number (10 digits starting with 6-9)';
                        break;
                }
                
            debugLog('Validating phone...');
                if (!phone) {
                debugLog('âŒ Phone validation failed: empty');
                    showFieldError(document.getElementById('signup-phone'), 'Mobile number is required');
                    isValid = false;
                } else if (!validatePhone(phone)) {
                debugLog('âŒ Phone validation failed: invalid format');
                    showFieldError(document.getElementById('signup-phone'), phoneErrorMessage);
                    isValid = false;
            } else {
                debugLog('âœ… Phone validation passed');
                }

                // Validate first name
            debugLog('Validating first name...');
                if (!firstName) {
                debugLog('âŒ First name validation failed: empty');
                    showFieldError(document.getElementById('signup-firstname'), 'First name is required');
                    isValid = false;
                } else if (!validateName(firstName)) {
                debugLog('âŒ First name validation failed: too short');
                    showFieldError(document.getElementById('signup-firstname'), 'First name must be at least 2 characters');
                    isValid = false;
            } else {
                debugLog('âœ… First name validation passed');
                }

                // Validate last name
            debugLog('Validating last name...');
                if (!lastName) {
                debugLog('âŒ Last name validation failed: empty');
                    showFieldError(document.getElementById('signup-lastname'), 'Last name is required');
                    isValid = false;
                } else if (!validateName(lastName)) {
                debugLog('âŒ Last name validation failed: too short');
                    showFieldError(document.getElementById('signup-lastname'), 'Last name must be at least 2 characters');
                    isValid = false;
            } else {
                debugLog('âœ… Last name validation passed');
                }

                // Validate terms
            debugLog('Validating terms checkbox...');
                if (!terms) {
                debugLog('âŒ Terms validation failed: not checked');
                    const termsCheckbox = document.getElementById('signup-terms');
                    const errorSpan = termsCheckbox.closest('label').nextElementSibling;
                    if (errorSpan && errorSpan.classList.contains('error-message')) {
                        errorSpan.textContent = 'You must agree to the terms and conditions';
                        errorSpan.classList.remove('hidden');
                    }
                    isValid = false;
            } else {
                debugLog('âœ… Terms validation passed');
                }

            debugLog('=== VALIDATION COMPLETE ===');
            debugLog('Form is valid:', isValid);
            
                if (!isValid) {
                debugError('âŒ Form validation failed, stopping submission');
                    showFormMessage('Please correct the errors above', 'error');
                    return false;
                }

            debugLog('âœ… All validations passed, proceeding with submission');

                // Get product RRP
                console.log('=== GETTING PRODUCT RRP ===');
                console.log('Product ID (raw):', selectedProductId);
                console.log('Product ID type:', typeof selectedProductId);
                const productIdNum = parseInt(selectedProductId);
                console.log('Product ID (parsed):', productIdNum);
                console.log('Product ID (parsed) type:', typeof productIdNum);
                console.log('getRRP function type:', typeof getRRP);
                console.log('getRRP function:', getRRP);
                
                debugLog('=== GETTING PRODUCT RRP ===');
                debugLog('Product ID:', selectedProductId);
                debugLog('getRRP function type:', typeof getRRP);
                let rrp;
                try {
                    if (typeof getRRP !== 'function') {
                        throw new Error('getRRP function not available');
                    }
                    console.log('Calling getRRP with:', productIdNum);
                    // Direct test - check if we can access PRODUCT_CONFIG
                    console.log('Testing direct lookup - checking if 32 exists in config...');
                    rrp = getRRP(productIdNum);
                    
                    // If null, try to debug why
                    if (rrp === null) {
                        console.warn('âš ï¸ getRRP returned null for product ID:', productIdNum);
                        console.warn('This means the product ID is not in PRODUCT_CONFIG');
                        console.warn('Expected: 486 for product ID 32');
                        // Try calling the function directly to see what happens
                        console.log('Function toString:', getRRP.toString());
                    }
                    debugLog('âœ… RRP retrieved:', rrp);
                } catch (error) {
                    debugError('âŒ Error getting RRP:', error);
                    debugError('Error stack:', error.stack);
                    alert('Error getting product price. Product ID: ' + selectedProductId);
                    rrp = null;
                }
                
                if (!rrp) {
                    const errorMsg = 'Invalid product selected. Please try again. Product ID: ' + selectedProductId;
                    debugError('âŒ Invalid RRP for product ID:', selectedProductId);
                    alert(errorMsg);
                    showFormMessage(errorMsg, 'error');
                    return false;
                }
                debugLog('âœ… RRP check passed:', rrp);

                // Get Facebook pixel
                debugLog('=== GETTING FACEBOOK PIXEL ===');
                let pixel;
                try {
                    pixel = getFacebookPixel();
                    debugLog('Facebook pixel retrieved:', pixel ? pixel.substring(0, 20) + '...' : 'empty');
                    if (!pixel || pixel === 'xxxxx') {
                        debugWarn('âš ï¸ Facebook pixel not found, using default value');
                    }
                } catch (error) {
                    debugError('âŒ Error getting Facebook pixel:', error);
                    pixel = 'xxxxx';
                }

                // Get dealer ID and campaign
                debugLog('=== GETTING DEALER/CAMPAIGN INFO ===');
                const dealerId = DEALER_ID || 533;
                const campaign = CAMPAIGN_NAME || 'joinassure';
                debugLog('Dealer ID:', dealerId);
                debugLog('Campaign:', campaign);
                
                debugLog('=== BUILDING URL PARAMETERS ===');
                debugLog('URL data:', {
                    email: email ? email.substring(0, 3) + '***' : 'empty',
                    firstName: firstName || 'empty',
                    lastName: lastName || 'empty',
                    phone: phone ? phone.substring(0, 3) + '***' : 'empty',
                    productId: selectedProductId,
                    rrp: rrp,
                    iddealer: dealerId,
                    campaign: campaign,
                    pixel: pixel ? pixel.substring(0, 10) + '...' : 'empty'
                });

                // Build URL
                debugLog('Building URLSearchParams...');
                const params = new URLSearchParams({
                    email: email,
                    firstName: firstName,
                    lastName: lastName,
                    phone: phone,
                    productId: selectedProductId,
                    rrp: rrp,
                    iddealer: dealerId,
                    campaign: campaign,
                    pixel: pixel
                });
                debugLog('âœ… URLSearchParams created:', params.toString());

                const redirectUrl = `https://my.assurescratchanddent.com/signup?${params.toString()}`;
                debugLog('=== REDIRECT URL GENERATED ===');
                debugLog('Full URL:', redirectUrl);
                debugLog('URL length:', redirectUrl.length);

                // Disable submit button
                debugLog('=== DISABLING SUBMIT BUTTON ===');
                const btn = document.getElementById('signupSubmit');
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = 'Processing...';
                    debugLog('âœ… Submit button disabled');
                } else {
                    debugWarn('âš ï¸ Submit button not found!');
                }

                // Upload to S3 via form-handler before redirect
                debugLog('=== UPLOADING TO S3 VIA FORM-HANDLER ===');
                const formHandlerPayload = {
                    payload: {
                        data: {
                            firstname: firstName,
                            lastname: lastName,
                            email: email,
                            phone: phone,
                            state: '',
                            comment_or_question: `Membership signup - Product: ${selectedProductId}, Campaign: ${campaign}`,
                            time: '',
                            gclid: '',
                            leadSource: campaign || 'Join Assure USA'
                        }
                    }
                };
                try {
                    const s3Response = await fetch('/.netlify/functions/form-handler', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formHandlerPayload)
                    });
                    const s3Result = await s3Response.json().catch(() => ({}));
                    if (!s3Response.ok) {
                        debugWarn('âš ï¸ S3 upload failed, but continuing with redirect:', s3Result);
                    } else {
                        debugLog('âœ… S3 upload successful');
                    }
                } catch (s3Err) {
                    debugWarn('âš ï¸ S3 upload error (continuing with redirect):', s3Err);
                }

                // Small delay to ensure button state updates, then open in new tab
                debugLog('=== SETTING TIMEOUT FOR REDIRECT ===');
                setTimeout(() => {
                    debugLog('=== TIMEOUT FIRED - ATTEMPTING REDIRECT ===');
                    debugLog('Redirect URL:', redirectUrl);
                    debugLog('Window object:', typeof window);
                    debugLog('window.open available:', typeof window.open);
                    
                    try {
                        const newWindow = window.open(redirectUrl, '_blank');
                        debugLog('window.open() called, returned:', newWindow);
                        debugLog('newWindow type:', typeof newWindow);
                        debugLog('newWindow closed:', newWindow ? newWindow.closed : 'N/A');
                        
                        // Check if popup was blocked
                        if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                            // Popup was blocked, fall back to same-window navigation
                            debugWarn('âš ï¸ Popup blocked, redirecting in same window');
                            debugLog('Using window.location.href:', redirectUrl);
                            window.location.href = redirectUrl;
                            debugLog('âœ… window.location.href set');
                        } else {
                            // Popup opened successfully, close the modal
                            debugLog('âœ… Redirect opened successfully in new tab');
                    setTimeout(() => {
                                debugLog('=== CLOSING MODAL ===');
                        if (MicroModal && typeof MicroModal.close === 'function') {
                                    debugLog('Closing modal with MicroModal.close()');
                            MicroModal.close('signupModal');
                                    debugLog('âœ… Modal close called');
                                } else {
                                    debugWarn('âš ï¸ MicroModal not available or close function missing');
                        }
                    }, 500);
                        }
                    } catch (redirectError) {
                        debugError('âŒ Error during redirect:', redirectError);
                        debugError('Error stack:', redirectError.stack);
                        alert('Error redirecting: ' + redirectError.message);
                    }
                }, 150);
                
                debugLog('=== FORM HANDLER COMPLETED SUCCESSFULLY ===');
                return false; // Prevent default form submission
            } catch (error) {
                debugError('âŒâŒâŒ CRITICAL ERROR IN FORM SUBMISSION âŒâŒâŒ');
                debugError('Error message:', error.message);
                debugError('Error stack:', error.stack);
                debugError('Error name:', error.name);
                debugError('Full error object:', error);
                alert('An error occurred: ' + error.message);
                showFormMessage('An error occurred. Please try again.', 'error');
                return false;
            }
        }

        // Attach handler to form submit event (with capture to catch early)
        debugLog('=== ATTACHING EVENT LISTENERS ===');
        debugLog('Form element:', form);
        debugLog('Submit button element:', submitBtn);
        
        // Prevent form submission - attach with capture phase to run first
        form.addEventListener('submit', function(e) {
            // IMMEDIATE LOG - Always show form submit
            console.log('ðŸ”µ FORM SUBMIT EVENT TRIGGERED');
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            debugLog('ðŸ”µ FORM SUBMIT EVENT TRIGGERED');
            handleFormSubmit(e);
            return false;
        }, true); // Use capture phase to run before other handlers
        
        debugLog('âœ… Form submit listener attached (with capture)');
        
        // Attach handler directly to button click (primary handler)
        submitBtn.addEventListener('click', function(e) {
            // IMMEDIATE LOG - Always show button clicks
            console.log('ðŸ”µðŸ”µðŸ”µ BUTTON CLICKED DIRECTLY ðŸ”µðŸ”µðŸ”µ');
            console.log('Click event type:', e.type);
            console.log('Button element:', submitBtn);
            console.log('Button disabled:', submitBtn.disabled);
            console.log('Button type:', submitBtn.type);
            
            debugLog('ðŸ”µðŸ”µðŸ”µ BUTTON CLICKED DIRECTLY ðŸ”µðŸ”µðŸ”µ');
            debugLog('Click event:', e);
            debugLog('Button element:', submitBtn);
            
            // Prevent any default behavior
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            // Call handler
            handleFormSubmit(e);
            
            return false;
        }, true); // Use capture phase
        
        // IMMEDIATE LOG - Always confirm listener attached
        console.log('âœ… Button click listener attached to:', submitBtn.id);
        debugLog('âœ… Button click listener attached');
        
        // Also try mousedown as another fallback
        submitBtn.addEventListener('mousedown', function(e) {
            // IMMEDIATE LOG - Always show mousedown
            console.log('ðŸ”µ Button mousedown event detected');
            debugLog('ðŸ”µ Button mousedown event');
        }, false);
        
        // IMMEDIATE LOG - Always confirm all listeners attached
        console.log('âœ…âœ…âœ… ALL EVENT LISTENERS ATTACHED âœ…âœ…âœ…');
        debugLog('=== ALL EVENT LISTENERS ATTACHED ===');
    }

    // Initialize form handler when DOM is ready
    console.log('ðŸ“‹ Setting up form handler initialization...');
    console.log('Document ready state:', document.readyState);
    
    // Add a global test function to check button from console
    window.testSignupButton = function() {
        const btn = document.getElementById('signupSubmit');
        const form = document.getElementById('signupForm');
        console.log('ðŸ§ª TEST: Button exists:', !!btn);
        console.log('ðŸ§ª TEST: Form exists:', !!form);
        if (btn) {
            console.log('ðŸ§ª TEST: Button disabled:', btn.disabled);
            console.log('ðŸ§ª TEST: Button type:', btn.type);
            console.log('ðŸ§ª TEST: Button text:', btn.textContent);
            console.log('ðŸ§ª TEST: Button onclick:', btn.onclick);
            console.log('ðŸ§ª TEST: Button has event listeners:', btn.onclick !== null);
        }
        return { button: btn, form: form };
    };
    console.log('ðŸ’¡ Tip: Run testSignupButton() in console to check button status');
    
    if (document.readyState === 'loading') {
        console.log('â³ Document still loading, waiting for DOMContentLoaded...');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('âœ… DOMContentLoaded fired, initializing form handler...');
            initFormHandler();
        });
    } else {
        console.log('âœ… Document already ready, initializing form handler immediately...');
        initFormHandler();
    }
    
    // Also try to attach a listener immediately if button exists (for dynamically loaded modals)
    setTimeout(function() {
        const testBtn = document.getElementById('signupSubmit');
        if (testBtn) {
            console.log('ðŸ” Found button after timeout, ensuring click handler...');
            // Don't duplicate, but log that we found it
            console.log('Button found at:', new Date().toISOString());
        } else {
            console.warn('âš ï¸ Button still not found after timeout');
        }
    }, 2000);

    // Clear errors on input - wait for form to exist
    function initInputHandlers() {
        const form = document.getElementById('signupForm');
        if (!form) {
            setTimeout(initInputHandlers, 100);
            return;
        }

        form.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', () => {
                clearFieldError(input);
            });
        });
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initInputHandlers);
    } else {
        initInputHandlers();
    }
</script>

